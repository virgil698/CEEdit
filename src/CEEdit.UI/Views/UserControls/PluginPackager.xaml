<UserControl x:Class="CEEdit.UI.Views.UserControls.PluginPackager"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="900">
    
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/CEEdit;component/src/CEEdit.UI/Themes/ModernTheme.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>
    
    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
        <StackPanel Margin="{StaticResource DefaultMargin}">
            
            <!-- 构建配置 -->
            <GroupBox Header="构建配置" Style="{StaticResource ModernGroupBoxStyle}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- 输出路径 -->
                    <TextBlock Grid.Row="0" Grid.Column="0" Text="输出路径:" Style="{StaticResource BodyTextStyle}" VerticalAlignment="Center"/>
                    <Grid Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="3">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Grid.Column="0"
                                 Text="{Binding OutputPath, UpdateSourceTrigger=PropertyChanged}"
                                 Style="{StaticResource ModernTextBoxStyle}"
                                 ToolTip="插件输出的文件夹路径"/>
                        <Button Grid.Column="1" Content="浏览" 
                                Style="{StaticResource ModernButtonStyle}"
                                Command="{Binding BrowseOutputPathCommand}" 
                                Margin="4,0,0,0"/>
                    </Grid>

                    <!-- 版本号 -->
                    <TextBlock Grid.Row="1" Grid.Column="0" Text="版本号" Style="{StaticResource BodyTextStyle}" VerticalAlignment="Center"/>
                    <TextBox Grid.Row="1" Grid.Column="1" 
                             Text="{Binding VersionNumber, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource ModernTextBoxStyle}"
                             ToolTip="插件的版本号 (例如: 1.0.0)"/>
                    
                    <!-- 构建类型 -->
                    <TextBlock Grid.Row="1" Grid.Column="2" Text="构建类型:" Style="{StaticResource BodyTextStyle}" VerticalAlignment="Center"/>
                    <ComboBox Grid.Row="1" Grid.Column="3"
                              SelectedItem="{Binding BuildType}"
                              Style="{StaticResource ModernComboBoxStyle}"
                              ItemsSource="{Binding AvailableBuildTypes}"
                              ToolTip="选择构建类型"/>

                    <!-- 目标版本 -->
                    <TextBlock Grid.Row="2" Grid.Column="0" Text="目标版本:" Style="{StaticResource BodyTextStyle}" VerticalAlignment="Center"/>
                    <ComboBox Grid.Row="2" Grid.Column="1"
                              SelectedItem="{Binding TargetVersion}"
                              Style="{StaticResource ModernComboBoxStyle}"
                              ItemsSource="{Binding AvailableTargetVersions}"
                              ToolTip="CraftEngine目标版本"/>
                    
                    <!-- 压缩级别 -->
                    <TextBlock Grid.Row="2" Grid.Column="2" Text="压缩级别:" Style="{StaticResource BodyTextStyle}" VerticalAlignment="Center"/>
                    <ComboBox Grid.Row="2" Grid.Column="3"
                              SelectedItem="{Binding CompressionLevel}"
                              Style="{StaticResource ModernComboBoxStyle}"
                              ItemsSource="{Binding AvailableCompressionLevels}"
                              ToolTip="文件压缩级别"/>

                    <!-- 构建选项 -->
                    <TextBlock Grid.Row="3" Grid.Column="0" Text="构建选项:" Style="{StaticResource BodyTextStyle}" VerticalAlignment="Top"/>
                    <StackPanel Grid.Row="3" Grid.Column="1" Grid.ColumnSpan="3">
                        <CheckBox Content="包含调试信息" 
                                  IsChecked="{Binding IncludeDebugInfo}"
                                  Style="{StaticResource ModernCheckBoxStyle}"
                                  ToolTip="在输出中包含调试信息"/>
                        <CheckBox Content="优化资源文件" 
                                  IsChecked="{Binding OptimizeResources}"
                                  Style="{StaticResource ModernCheckBoxStyle}"
                                  ToolTip="自动优化纹理、模型等资源文件"/>
                        <CheckBox Content="验证插件完整性" 
                                  IsChecked="{Binding ValidatePlugin}"
                                  Style="{StaticResource ModernCheckBoxStyle}"
                                  ToolTip="构建前验证插件的完整性"/>
                        <CheckBox Content="生成依赖清单" 
                                  IsChecked="{Binding GenerateManifest}"
                                  Style="{StaticResource ModernCheckBoxStyle}"
                                  ToolTip="生成插件依赖关系清单文件"/>
                    </StackPanel>
                </Grid>
            </GroupBox>

            <!-- 包含文件 -->
            <GroupBox Header="包含文件" Style="{StaticResource ModernGroupBoxStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="200"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- 工具栏-->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                        <Button Content="全选" 
                                Style="{StaticResource ModernButtonStyle}"
                                Command="{Binding SelectAllFilesCommand}"/>
                        <Button Content="全不选" 
                                Style="{StaticResource ModernButtonStyle}"
                                Command="{Binding DeselectAllFilesCommand}" Margin="8,0,0,0"/>
                        <Button Content="刷新" 
                                Style="{StaticResource ModernButtonStyle}"
                                Command="{Binding RefreshFilesCommand}" Margin="8,0,0,0"/>
                        
                        <Separator Background="{StaticResource BorderBrush}" Width="1" Margin="16,4"/>
                        
                        <TextBlock Text="筛选" Style="{StaticResource BodyTextStyle}" 
                                   VerticalAlignment="Center" Margin="8,0,4,0"/>
                        <ComboBox SelectedItem="{Binding FileFilter}"
                                  Style="{StaticResource ModernComboBoxStyle}"
                                  Width="120">
                            <ComboBoxItem Content="所有文件"/>
                            <ComboBoxItem Content="源文件"/>
                            <ComboBoxItem Content="资源文件"/>
                            <ComboBoxItem Content="配置文件"/>
                        </ComboBox>
                    </StackPanel>
                    
                    <!-- 文件列表 -->
                    <DataGrid Grid.Row="1" 
                              ItemsSource="{Binding ProjectFiles}"
                              Style="{StaticResource ModernDataGridStyle}"
                              RowStyle="{StaticResource ModernDataGridRowStyle}"
                              ColumnHeaderStyle="{StaticResource ModernDataGridColumnHeaderStyle}">
                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn Header="包含" Binding="{Binding IsIncluded}" Width="60"/>
                            <DataGridTextColumn Header="文件名称" Binding="{Binding Name}" Width="*"/>
                            <DataGridTextColumn Header="类型" Binding="{Binding Type}" Width="100"/>
                            <DataGridTextColumn Header="大小" Binding="{Binding SizeFormatted}" Width="80"/>
                            <DataGridTextColumn Header="路径" Binding="{Binding RelativePath}" Width="200"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    
                    <!-- 统计信息 -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,8,0,0">
                        <TextBlock Text="{Binding SelectedFilesCount, StringFormat='已选择 {0} 个文件'}" 
                                   Style="{StaticResource BodyTextStyle}" Margin="0,0,16,0"/>
                        <TextBlock Text="{Binding TotalSelectedSize}" 
                                   Style="{StaticResource SecondaryTextStyle}"/>
                    </StackPanel>
                </Grid>
            </GroupBox>

            <!-- 构建过程 -->
            <GroupBox Header="构建过程" Style="{StaticResource ModernGroupBoxStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="200"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- 进度信息 -->
                    <Grid Grid.Row="0" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel Grid.Column="0">
                            <TextBlock Text="{Binding BuildStatus}" Style="{StaticResource BodyTextStyle}"/>
                            <ProgressBar Value="{Binding BuildProgress}" 
                                         Maximum="100" 
                                         Height="8" 
                                         Margin="0,4,0,0"
                                         Background="{StaticResource TertiaryBackgroundBrush}"
                                         Foreground="{StaticResource AccentBrush}"/>
                        </StackPanel>
                        
                        <TextBlock Grid.Column="1" 
                                   Text="{Binding BuildProgress, StringFormat={}{0:F0}%}" 
                                   Style="{StaticResource BodyTextStyle}" 
                                   VerticalAlignment="Center" 
                                   Margin="8,0,0,0"/>
                    </Grid>
                    
                    <!-- 构建日志 -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <TextBox Text="{Binding BuildLog}" 
                                 Style="{StaticResource ModernTextBoxStyle}"
                                 IsReadOnly="True"
                                 TextWrapping="Wrap"
                                 FontFamily="{StaticResource CodeFontFamily}"
                                 FontSize="{StaticResource SmallFontSize}"
                                 Background="{StaticResource TertiaryBackgroundBrush}"/>
                    </ScrollViewer>
                    
                    <!-- 构建结果 -->
                    <Border Grid.Row="2" 
                            Background="{StaticResource SecondaryBackgroundBrush}"
                            BorderBrush="{StaticResource BorderBrush}"
                            BorderThickness="1"
                            CornerRadius="4"
                            Padding="8"
                            Margin="0,8,0,0"
                            Visibility="{Binding ShowBuildResult, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Grid.Column="0" 
                                       Text="{Binding BuildResultIcon}" 
                                       FontSize="24" 
                                       VerticalAlignment="Center" 
                                       Margin="0,0,8,0"/>
                            
                            <StackPanel Grid.Column="1">
                                <TextBlock Text="{Binding BuildResultTitle}" 
                                           Style="{StaticResource SubHeaderTextStyle}" 
                                           Margin="0"/>
                                <TextBlock Text="{Binding BuildResultMessage}" 
                                           Style="{StaticResource BodyTextStyle}" 
                                           Margin="0,2,0,0"/>
                                <TextBlock Text="{Binding OutputFilePath}" 
                                           Style="{StaticResource SecondaryTextStyle}" 
                                           Margin="0,2,0,0"/>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="2" Orientation="Horizontal">
                                <Button Content="打开文件夹" 
                                        Style="{StaticResource ModernButtonStyle}"
                                        Command="{Binding OpenOutputFolderCommand}" 
                                        Margin="0,0,4,0"
                                        Visibility="{Binding BuildSuccessful, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                <Button Content="运行插件" 
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        Command="{Binding RunPluginCommand}"
                                        Visibility="{Binding BuildSuccessful, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </GroupBox>

            <!-- 快速操作-->
            <GroupBox Header="快速操作" Style="{StaticResource ModernGroupBoxStyle}">
                <UniformGrid Rows="2" Columns="3">
                    <Button Content="构建调试版本" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding BuildDebugCommand}" 
                            Margin="4"
                            ToolTip="快速构建用于调试的版本"/>
                    <Button Content="构建发布版本" 
                            Style="{StaticResource PrimaryButtonStyle}"
                            Command="{Binding BuildReleaseCommand}" 
                            Margin="4"
                            ToolTip="构建用于发布的优化版本"/>
                    <Button Content="清理输出" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding CleanOutputCommand}" 
                            Margin="4"
                            ToolTip="清理输出文件"/>
                    
                    <Button Content="验证项目" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding ValidateProjectCommand}" 
                            Margin="4"
                            ToolTip="验证项目完整性"/>
                    <Button Content="导出模板" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding ExportTemplateCommand}" 
                            Margin="4"
                            ToolTip="将项目导出为模板"/>
                    <Button Content="发布到服务器" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding PublishToServerCommand}" 
                            Margin="4"
                            ToolTip="直接发布到测试服务器"/>
                </UniformGrid>
            </GroupBox>

            <!-- 操作按钮 -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0">
                <Button Content="保存配置" 
                        Style="{StaticResource ModernButtonStyle}"
                        Command="{Binding SaveConfigCommand}" Margin="4"/>
                <Button Content="载入配置" 
                        Style="{StaticResource ModernButtonStyle}"
                        Command="{Binding LoadConfigCommand}" Margin="4"/>
                <Button Content="开始构建" 
                        Style="{StaticResource PrimaryButtonStyle}"
                        Command="{Binding StartBuildCommand}" Margin="4"/>
            </StackPanel>
        </StackPanel>
    </ScrollViewer>
</UserControl>
