<UserControl x:Class="CEEdit.UI.Views.UserControls.YamlEditor"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="900">
    
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/CEEdit;component/src/CEEdit.UI/Themes/ModernTheme.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- 工具栏 -->
        <Border Grid.Row="0" Background="{StaticResource SecondaryBackgroundBrush}" 
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
            <Grid Margin="{StaticResource DefaultMargin}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <!-- 左侧工具 -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="新建文件" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding NewFileCommand}" 
                            Margin="0,0,8,0"/>
                    <Button Content="打开文件" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding OpenFileCommand}" 
                            Margin="0,0,8,0"/>
                    <Button Content="保存" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding SaveFileCommand}" 
                            Margin="0,0,8,0"/>
                    <Button Content="另存为"
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding SaveAsFileCommand}" 
                            Margin="0,0,16,0"/>
                    
                    <Separator Background="{StaticResource BorderBrush}" Width="1" Margin="0,4"/>
                    
                    <Button Style="{StaticResource IconButtonStyle}"
                            Command="{Binding UndoCommand}" 
                            Margin="8,0,4,0"
                            ToolTip="撤销 (Ctrl+Z)">
                        <TextBlock Text="{StaticResource UndoIconGlyph}" 
                                   FontFamily="{StaticResource DefaultFontFamily}" FontSize="14"/>
                    </Button>
                    <Button Style="{StaticResource IconButtonStyle}"
                            Command="{Binding RedoCommand}" 
                            Margin="0,0,16,0"
                            ToolTip="重做 (Ctrl+Y)">
                        <TextBlock Text="{StaticResource RedoIconGlyph}" 
                                   FontFamily="{StaticResource DefaultFontFamily}" FontSize="14"/>
                    </Button>
                    
                    <Separator Background="{StaticResource BorderBrush}" Width="1" Margin="0,4"/>
                    
                    <Button Content="查找" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding FindCommand}" 
                            Margin="8,0,4,0"
                            ToolTip="查找 (Ctrl+F)"/>
                    <Button Content="替换" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding ReplaceCommand}" 
                            Margin="0,0,16,0"
                            ToolTip="替换 (Ctrl+H)"/>
                    
                    <Separator Background="{StaticResource BorderBrush}" Width="1" Margin="0,4"/>
                    
                    <Button Content="格式化"
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding FormatCommand}" 
                            Margin="8,0,4,0"
                            ToolTip="格式化YAML"/>
                    <Button Content="验证" 
                            Style="{StaticResource ModernButtonStyle}"
                            Command="{Binding ValidateCommand}" 
                            Margin="0,0,8,0"
                            ToolTip="验证YAML语法"/>
                </StackPanel>
                
                <!-- 右侧信息 -->
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <TextBlock Text="{Binding CurrentFileName}" 
                               Style="{StaticResource BodyTextStyle}" 
                               VerticalAlignment="Center" 
                               Margin="0,0,16,0"/>
                    <TextBlock Text="{Binding LineColumnInfo}" 
                               Style="{StaticResource SecondaryTextStyle}" 
                               VerticalAlignment="Center" 
                               Margin="0,0,8,0"/>
                    <TextBlock Text="{Binding EncodingInfo}" 
                               Style="{StaticResource SecondaryTextStyle}" 
                               VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- 主编辑区-->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="250" MinWidth="200"/>
            </Grid.ColumnDefinitions>
            
            <!-- 行号 -->
            <Border Grid.Column="0" Background="{StaticResource TertiaryBackgroundBrush}" 
                    BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,1,0"
                    Visibility="{Binding ShowLineNumbers, Converter={StaticResource BooleanToVisibilityConverter}}">
                <TextBlock x:Name="LineNumbers" 
                           FontFamily="{StaticResource CodeFontFamily}"
                           FontSize="{StaticResource SmallFontSize}"
                           Foreground="{StaticResource SecondaryTextBrush}"
                           Padding="8,4"
                           TextAlignment="Right"
                           Text="{Binding LineNumbersText}"/>
            </Border>
            
            <!-- 代码编辑-->
            <ScrollViewer Grid.Column="1" 
                          VerticalScrollBarVisibility="Auto" 
                          HorizontalScrollBarVisibility="Auto"
                          Background="{StaticResource BackgroundBrush}">
                <TextBox x:Name="CodeEditor"
                         Text="{Binding YamlContent, UpdateSourceTrigger=PropertyChanged}"
                         FontFamily="{StaticResource CodeFontFamily}"
                         FontSize="{StaticResource DefaultFontSize}"
                         Background="Transparent"
                         BorderThickness="0"
                         AcceptsReturn="True"
                         AcceptsTab="True"
                         TextWrapping="NoWrap"
                         VerticalScrollBarVisibility="Disabled"
                         HorizontalScrollBarVisibility="Disabled"
                         Padding="8,4"
                         SelectionChanged="CodeEditor_SelectionChanged"
                         TextChanged="CodeEditor_TextChanged"/>
            </ScrollViewer>
            
            <!-- 分隔线-->
            <GridSplitter Grid.Column="2" Width="4" 
                          Background="{StaticResource BorderBrush}" 
                          HorizontalAlignment="Center" 
                          VerticalAlignment="Stretch"/>
            
            <!-- 右侧面板 -->
            <Grid Grid.Column="3">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="150" MinHeight="100"/>
                </Grid.RowDefinitions>
                
                <!-- 大纲视图 -->
                <Border Grid.Row="0" Background="{StaticResource SecondaryBackgroundBrush}" 
                        BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                    <TextBlock Text="文档大纲" Style="{StaticResource SubHeaderTextStyle}" 
                               Margin="{StaticResource DefaultMargin}"/>
                </Border>
                
                <TreeView Grid.Row="1" 
                          ItemsSource="{Binding DocumentOutline}"
                          Style="{StaticResource ModernTreeViewStyle}"
                          ItemContainerStyle="{StaticResource ModernTreeViewItemStyle}">
                    <TreeView.ItemTemplate>
                        <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{StaticResource ChevronRightIconGlyph}" 
                                           Style="{StaticResource TreeViewIconStyle}"/>
                                <TextBlock Text="{Binding Name}" Style="{StaticResource BodyTextStyle}"/>
                                <TextBlock Text="{Binding Type}" Style="{StaticResource SecondaryTextStyle}" 
                                           Margin="8,0,0,0"/>
                            </StackPanel>
                        </HierarchicalDataTemplate>
                    </TreeView.ItemTemplate>
                </TreeView>
                
                <!-- 分隔线-->
                <GridSplitter Grid.Row="2" Height="4" 
                              Background="{StaticResource BorderBrush}" 
                              HorizontalAlignment="Stretch"/>
                
                <!-- 错误和警告面板-->
                <Grid Grid.Row="3">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <Border Grid.Row="0" Background="{StaticResource SecondaryBackgroundBrush}" 
                            BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,0,0,1">
                        <StackPanel Orientation="Horizontal" Margin="{StaticResource DefaultMargin}">
                            <TextBlock Text="问题" Style="{StaticResource SubHeaderTextStyle}" Margin="0"/>
                            <TextBlock Text="{Binding ErrorCount, StringFormat='({0})'}" 
                                       Style="{StaticResource SecondaryTextStyle}" 
                                       Foreground="{StaticResource ErrorBrush}" 
                                       Margin="8,0,0,0"/>
                        </StackPanel>
                    </Border>
                    
                    <ListBox Grid.Row="1" 
                             ItemsSource="{Binding ValidationErrors}"
                             Style="{StaticResource ModernListBoxStyle}"
                             ItemContainerStyle="{StaticResource ModernListBoxItemStyle}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" Margin="4">
                                    <Ellipse Width="8" Height="8" 
                                             Fill="{Binding Severity, Converter={StaticResource SeverityToBrushConverter}}" 
                                             Margin="0,0,8,0" 
                                             VerticalAlignment="Center"/>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Message}" Style="{StaticResource BodyTextStyle}"/>
                                        <TextBlock Text="{Binding Location}" Style="{StaticResource SecondaryTextStyle}"/>
                                    </StackPanel>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Grid>
        </Grid>
        
        <!-- 状态栏 -->
        <Border Grid.Row="2" Background="{StaticResource SecondaryBackgroundBrush}" 
                BorderBrush="{StaticResource BorderBrush}" BorderThickness="0,1,0,0">
            <Grid Margin="{StaticResource DefaultMargin}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="{Binding StatusMessage}" 
                               Style="{StaticResource BodyTextStyle}" 
                               VerticalAlignment="Center"/>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <CheckBox Content="显示行号" 
                              IsChecked="{Binding ShowLineNumbers}"
                              Style="{StaticResource ModernCheckBoxStyle}" 
                              Margin="0,0,16,0"/>
                    <CheckBox Content="自动换行" 
                              IsChecked="{Binding WordWrap}"
                              Style="{StaticResource ModernCheckBoxStyle}" 
                              Margin="0,0,16,0"/>
                    <TextBlock Text="Tab大小:" 
                               Style="{StaticResource BodyTextStyle}" 
                               VerticalAlignment="Center" 
                               Margin="0,0,4,0"/>
                    <ComboBox SelectedItem="{Binding TabSize}"
                              Style="{StaticResource ModernComboBoxStyle}"
                              Width="60">
                        <ComboBoxItem Content="2"/>
                        <ComboBoxItem Content="4"/>
                        <ComboBoxItem Content="8"/>
                    </ComboBox>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>